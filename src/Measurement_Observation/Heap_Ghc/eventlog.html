<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

      <title>Eventlog</title>
    
          <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/s4defs-roles.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../../_static/theme-vendors.js"></script> -->
      <script src="../../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../../genindex.html" />
  <link rel="search" title="Search" href="../../../search.html" />
  <link rel="next" title="GHC Debug" href="ghc_debug.html" />
  <link rel="prev" title="GHC Flags" href="ghc_flags.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../../contents.html" class="home-link">
    
      <span class="site-name">Haskell Optimization Handbook</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../contents.html#haskell-optimization-handbook">Table of Contents</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../Preliminaries/index.html" class="reference internal ">Preliminaries</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../index.html" class="reference internal ">Measurement, Profiling, and Observation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../Optimizations/index.html" class="reference internal ">Optimizations</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../../contents.html">Docs</a> &raquo;</li>
    
      <li><a href="../index.html">Measurement, Profiling, and Observation</a> &raquo;</li>
    
      <li><a href="index.html">Heap Profiling and Inspection : GHC Based Methods</a> &raquo;</li>
    
    <li>Eventlog</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="ghc_flags.html"
       title="previous chapter">← <span class="lightgrey">GHC Flags</span></a>
  </li>
  <li class="next">
    <a href="ghc_debug.html"
       title="next chapter"><span class="lightgrey">GHC Debug</span> →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <span class="target" id="eventlog-chapter"></span><section id="eventlog">
<h1>Eventlog<a class="headerlink" href="#eventlog" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://downloads.haskell.org/ghc/latest/docs/users_guide/runtime_control.html#rts-eventlog">Eventlog</a>
is a GHC runtime system feature that logs events at runtime of a compiled
program. It is able to provide profiling information on the heap, the garbage
collector, the scheduler, and arbitrary events that a user inserts into their
own code. Eventlog is a versatile profiling tool, and should be one of the first
tools in the profiling toolbox you reach for. Use eventlog when you are just
beginning to diagnose the problem and are gathering data and want to inspect the
heap, or, if you already suspect a sub-system, such as the garbage collector,
and want to visualize its behavior. This chapter walks through using eventlog to
inspect a small program that suffers from <a class="reference internal" href="../../Preliminaries/what_makes_fast_hs.html#excessive-closure-allocation"><span class="std std-ref">Excessive Closure Allocation</span></a>.
By the end of the chapter you should understand:</p>
<ol class="arabic simple">
<li><p>What information can you retrieve by using eventlog</p></li>
<li><p>How to build your program to use eventlog</p></li>
<li><p>How to visualize eventlog information</p></li>
<li><p>How to tune eventlog to inspect specific subsystems</p></li>
<li><p>How to tune eventlog to inspect specific pieces of code</p></li>
<li><p>When to use eventlog</p></li>
</ol>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>The program must be recompiled with the <code class="docutils literal notranslate"><span class="pre">-eventlog</span></code> GHC flag</p></li>
<li><p>A program to consume the <code class="docutils literal notranslate"><span class="pre">program.eventlog</span></code> file. We recommend
<a class="reference external" href="https://github.com/mpickering/eventlog2html">eventlog2html</a>; see also the relevant section in the <a class="reference external" href="https://downloads.haskell.org/~ghc/9.2.4/docs/html/users_guide/runtime_control.html#rts-eventlog">GHC User’s
Guide</a></p></li>
</ol>
</section>
<section id="what-information-do-i-receive-from-eventlog">
<h2>What Information Do I Receive From Eventlog?<a class="headerlink" href="#what-information-do-i-receive-from-eventlog" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>Eventlog logs events as a function of time. For a full list of events see the</dt><dd><p><a class="reference external" href="https://downloads.haskell.org/ghc/latest/docs/users_guide/runtime_control.html#rts-eventlog">GHC User’s Guide</a>.
In general, the most common use case is to track heap events and arbitrary
user events to get a heap profile.</p>
</dd>
</dl>
</section>
<section id="when-should-i-use-eventlog">
<h2>When should I use Eventlog<a class="headerlink" href="#when-should-i-use-eventlog" title="Permalink to this headline">¶</a></h2>
<p>Eventlog is most useful when you need to <a class="reference internal" href="../the_recipe.html#characterize-the-problem"><span class="std std-ref">Characterize the Problem</span></a>. With</p>
</section>
<section id="the-running-example">
<h2>The Running Example<a class="headerlink" href="#the-running-example" title="Permalink to this headline">¶</a></h2>
<p>Our test program is an example of excessive closure allocation:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Need to disable optimizations because GHC will recognize and perform</span><span class="w"></span>
<span class="c1">-- let-floating for us!</span><span class="w"></span>
<span class="cm">{-# OPTIONS_GHC -O0 -ddump-simpl -ddump-to-file -ddump-stg-final #-}</span><span class="w"></span>

<span class="kr">module</span><span class="w"> </span><span class="nn">Main</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>

<span class="kr">import</span><span class="w"> </span><span class="nn">Gauge</span><span class="w"></span>

<span class="c1">-- | This function excessively allocates closures every time &#39;f&#39; is called. The</span><span class="w"></span>
<span class="c1">-- closure in question being the allocation of the 10k element list.</span><span class="w"></span>
<span class="nf">bad</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Int</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"></span>
<span class="nf">bad</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">fmap</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="w">  </span><span class="kr">where</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="mi">10000</span><span class="p">]</span><span class="w"></span>

<span class="c1">-- | This function avoids the excessive closure allocation. We still will</span><span class="w"></span>
<span class="c1">-- allocate thunks for every element of &#39;xs&#39; but we only calculate &#39;length</span><span class="w"></span>
<span class="c1">-- [1..10000]&#39; once because we floated it out of &#39;f&#39;.</span><span class="w"></span>
<span class="nf">good</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Int</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Int</span><span class="w"></span>
<span class="nf">good</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">fmap</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="w">  </span><span class="kr">where</span><span class="w"></span>
<span class="w">    </span><span class="n">n</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="mi">10000</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"></span>

<span class="c1">-- | use Gauge to run the benchmarks</span><span class="w"></span>
<span class="nf">main</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">test_values</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">replicate</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">defaultMain</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">bgroup</span><span class="w"> </span><span class="s">&quot;Too Many Closures&quot;</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">bench</span><span class="w"> </span><span class="s">&quot;bad&quot;</span><span class="w">  </span><span class="o">$</span><span class="w"> </span><span class="n">whnf</span><span class="w"> </span><span class="n">bad</span><span class="w"> </span><span class="n">test_values</span><span class="w"></span>
<span class="w">                                           </span><span class="p">,</span><span class="w"> </span><span class="n">bench</span><span class="w"> </span><span class="s">&quot;good&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">whnf</span><span class="w"> </span><span class="n">good</span><span class="w"> </span><span class="n">test_values</span><span class="w"></span>
<span class="w">                                           </span><span class="p">]</span><span class="w"></span>
<span class="w">              </span><span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>We define two functions <code class="docutils literal notranslate"><span class="pre">good</span></code> and <code class="docutils literal notranslate"><span class="pre">bad</span></code>. <code class="docutils literal notranslate"><span class="pre">bad</span></code> has excessive closure
allocation because <code class="docutils literal notranslate"><span class="pre">length</span> <span class="pre">[1..10000]</span></code> is nested inside of <code class="docutils literal notranslate"><span class="pre">f</span></code>. Thus the
list <code class="docutils literal notranslate"><span class="pre">[1..10000]</span></code> is repeatedly allocated, and <code class="docutils literal notranslate"><span class="pre">length</span> <span class="pre">[1..10000]</span></code> is
repeatedly computed for each call to <code class="docutils literal notranslate"><span class="pre">f</span></code>. <code class="docutils literal notranslate"><span class="pre">good</span></code> floats <code class="docutils literal notranslate"><span class="pre">length</span>
<span class="pre">[1..10000]</span></code> out of <code class="docutils literal notranslate"><span class="pre">f</span></code> so the list and <code class="docutils literal notranslate"><span class="pre">length</span></code> application only occur
once.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The full laziness optimization will produce <code class="docutils literal notranslate"><span class="pre">good</span></code> from <code class="docutils literal notranslate"><span class="pre">bad</span></code>.</p>
</div>
<p>GHC is good at spotting such code patterns so we’ve turned off optimizations
with the <code class="docutils literal notranslate"><span class="pre">OPTIONS_GHC</span> <span class="pre">-O0</span></code> pragma.</p>
</section>
<section id="building-with-eventlog-support">
<h2>Building with EventLog support<a class="headerlink" href="#building-with-eventlog-support" title="Permalink to this headline">¶</a></h2>
</section>
<section id="visualizing-eventlog">
<h2>Visualizing EventLog<a class="headerlink" href="#visualizing-eventlog" title="Permalink to this headline">¶</a></h2>
</section>
<section id="tuning-the-output">
<h2>Tuning the Output<a class="headerlink" href="#tuning-the-output" title="Permalink to this headline">¶</a></h2>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
</section>
<section id="references-and-further-reading">
<h2>References and Further Reading<a class="headerlink" href="#references-and-further-reading" title="Permalink to this headline">¶</a></h2>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="ghc_flags.html"
       title="previous chapter">← <span class="lightgrey">GHC Flags</span></a>
  </li>
  <li class="next">
    <a href="ghc_debug.html"
       title="next chapter"><span class="lightgrey">GHC Debug</span> →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2022-2022, Jeffrey Young (doyougnu).
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>