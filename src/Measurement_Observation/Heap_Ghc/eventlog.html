<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

      <title>2.2.2. Eventlog</title>
    
          <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/s4defs-roles.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../../_static/theme-vendors.js"></script> -->
      <script src="../../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../../genindex.html" />
  <link rel="search" title="Search" href="../../../search.html" />
  <link rel="next" title="2.2.3. GHC Debug" href="ghc_debug.html" />
  <link rel="prev" title="2.2.1. GHC Flags" href="ghc_flags.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../../contents.html" class="home-link">
    
      <span class="site-name">Haskell Optimization Handbook</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../contents.html#haskell-optimization-handbook">Table of Contents</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../Preliminaries/index.html" class="reference internal ">Preliminaries</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../index.html" class="reference internal ">Measurement, Profiling, and Observation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../Optimizations/index.html" class="reference internal ">Optimizations</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../../contents.html">Docs</a> &raquo;</li>
    
      <li><a href="../index.html"><span class="section-number">2. </span>Measurement, Profiling, and Observation</a> &raquo;</li>
    
      <li><a href="index.html"><span class="section-number">2.2. </span>Heap Profiling and Inspection : GHC Based Methods</a> &raquo;</li>
    
    <li><span class="section-number">2.2.2. </span>Eventlog</li>
  </ul>
  

  <ul class="page-nav">
  <li class="prev">
    <a href="ghc_flags.html"
       title="previous chapter">← <span class="section-number">2.2.1. </span><span class="lightgrey">GHC Flags</span></a>
  </li>
  <li class="next">
    <a href="ghc_debug.html"
       title="next chapter"><span class="section-number">2.2.3. </span><span class="lightgrey">GHC Debug</span> →</a>
  </li>
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <span class="target" id="eventlog-chapter"></span><section id="eventlog">
<h1><span class="section-number">2.2.2. </span>Eventlog<a class="headerlink" href="#eventlog" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://downloads.haskell.org/ghc/latest/docs/users_guide/runtime_control.html#rts-eventlog">Eventlog</a>
is a GHC runtime system feature that logs events at runtime of a compiled
program. It is able to provide profiling information on the heap, the garbage
collector, the scheduler, and arbitrary events that a user inserts into their
own code. Eventlog is a versatile profiling tool, and should be one of the first
tools in the profiling toolbox you reach for. Use eventlog when you are just
beginning to diagnose the problem and are gathering data and want to inspect the
heap, or, if you already suspect a sub-system, such as the garbage collector,
and want to visualize its behavior. This chapter walks through using eventlog to
inspect a small program that suffers from <a class="reference internal" href="../../Preliminaries/what_makes_fast_hs.html#excessive-closure-allocation"><span class="std std-ref">Excessive Closure Allocation</span></a>.
By the end of the chapter you should understand:</p>
<ol class="arabic simple">
<li><p>What information can you retrieve by using eventlog.</p></li>
<li><p>How to build your program to use eventlog.</p></li>
<li><p>How to visualize eventlog information.</p></li>
<li><p>How to tune eventlog to inspect specific subsystems.</p></li>
<li><p>How to tune eventlog to inspect specific pieces of code.</p></li>
<li><p>When to use eventlog.</p></li>
</ol>
<section id="requirements">
<h2><span class="section-number">2.2.2.1. </span>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>The program must be recompiled with the <code class="docutils literal notranslate"><span class="pre">-eventlog</span></code> GHC flag</p></li>
<li><p>A program to consume the <code class="docutils literal notranslate"><span class="pre">&lt;program&gt;.eventlog</span></code> file. We recommend
<a class="reference external" href="https://mpickering.github.io/eventlog2html/">eventlog2html</a>; see also the relevant section in the <a class="reference external" href="https://downloads.haskell.org/~ghc/9.2.4/docs/html/users_guide/runtime_control.html#rts-eventlog">GHC User’s
Guide</a>. You can also parse the
<code class="docutils literal notranslate"><span class="pre">&lt;program&gt;.eventlog</span></code> file using the <a class="reference external" href="https://hackage.haskell.org/package/ghc-events">ghc-events</a> library.</p></li>
</ol>
</section>
<section id="what-information-do-i-receive-from-eventlog">
<h2><span class="section-number">2.2.2.2. </span>What Information Do I Receive From Eventlog?<a class="headerlink" href="#what-information-do-i-receive-from-eventlog" title="Permalink to this headline">¶</a></h2>
<p>Eventlog logs events as a function of runtime. A full list of possible events is
available in <a class="reference external" href="https://downloads.haskell.org/~ghc/9.2.4/docs/html/users_guide/runtime_control.html#rts-eventlog">GHC User’s Guide</a>.
In general, the most common use case is to track heap events; which will be the
focus of this chapter. However, a user may define and track their own events
using the base functions <a class="reference external" href="https://downloads.haskell.org/~ghc/9.2.4/docs/html/libraries/base-4.16.3.0/Debug-Trace.html#v:traceMarker">traceEvent</a>
or <a class="reference external" href="https://downloads.haskell.org/~ghc/9.2.4/docs/html/libraries/base-4.16.3.0/Debug-Trace.html#v:traceMarker">traceMarker</a>
.</p>
</section>
<section id="when-should-i-use-eventlog">
<h2><span class="section-number">2.2.2.3. </span>When should I use Eventlog<a class="headerlink" href="#when-should-i-use-eventlog" title="Permalink to this headline">¶</a></h2>
<p>Eventlog is most useful when you need to <a class="reference internal" href="../the_recipe.html#characterize-the-problem"><span class="std std-ref">Characterize the Problem</span></a> . It
yields runtime information of the program specific to subsystems the program
relies on. Thus, it allows you to drill down into the behavior of the garbage
collector, the scheduler, the heap and so. For example, using the flag <code class="docutils literal notranslate"><span class="pre">+RTS</span>
<span class="pre">-lg</span></code> you can collect the <code class="docutils literal notranslate"><span class="pre">CONC_MARK_BEGIN</span></code> and <code class="docutils literal notranslate"><span class="pre">CONC_MARK_END</span></code> events which
log the beginning and end of the concurrent garbage collectors marking phase.
Similarly, you can collect <code class="docutils literal notranslate"><span class="pre">MEM_RETURN</span></code> which provides information about the
current allocation of megablocks, attempts to return them to the operating
system, and heap fragmentation.</p>
</section>
<section id="the-running-example">
<h2><span class="section-number">2.2.2.4. </span>The Running Example<a class="headerlink" href="#the-running-example" title="Permalink to this headline">¶</a></h2>
<p>Our test program is an example of excessive pointer chasing. The toy example
should be familiar to most Haskeller’s as a traditional example of a memory
leak:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="cm">{-# LANGUAGE BangPatterns #-}</span><span class="w"></span>
<span class="c1">-- Need to disable optimizations because GHC will recognize and perform</span><span class="w"></span>
<span class="c1">-- let-floating for us!</span><span class="w"></span>
<span class="cm">{-# OPTIONS_GHC -O0 -ddump-simpl -ddump-to-file -ddump-stg-final #-}</span><span class="w"></span>

<span class="kr">module</span><span class="w"> </span><span class="nn">Main</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>

<span class="kr">import</span><span class="w"> </span><span class="nn">Data.List</span><span class="w">              </span><span class="p">(</span><span class="nf">foldl&#39;</span><span class="p">)</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">System.Random</span><span class="w">          </span><span class="p">(</span><span class="nf">mkStdGen</span><span class="p">)</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">System.Random.Stateful</span><span class="w"> </span><span class="p">(</span><span class="nf">newIOGenM</span><span class="p">,</span><span class="w"> </span><span class="nf">uniformRM</span><span class="p">)</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Control.Concurrent</span><span class="w">     </span><span class="p">(</span><span class="nf">threadDelay</span><span class="p">)</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Control.Monad</span><span class="w">          </span><span class="p">(</span><span class="nf">replicateM</span><span class="p">)</span><span class="w"></span>

<span class="nf">lazy_mean</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Double</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Double</span><span class="w"></span>
<span class="nf">lazy_mean</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">fromIntegral</span><span class="w"> </span><span class="n">ln</span><span class="w"></span>
<span class="w">  </span><span class="kr">where</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ln</span><span class="p">)</span><span class="w">        </span><span class="ow">=</span><span class="w"> </span><span class="n">foldl</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="w">        </span><span class="n">step</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ln</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">ln</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="nf">stricter_mean</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Double</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Double</span><span class="w"></span>
<span class="nf">stricter_mean</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">fromIntegral</span><span class="w"> </span><span class="n">ln</span><span class="w"></span>
<span class="w">  </span><span class="kr">where</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ln</span><span class="p">)</span><span class="w">        </span><span class="ow">=</span><span class="w"> </span><span class="n">foldl&#39;</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="w">        </span><span class="n">step</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ln</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">ln</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="nf">strict_mean</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Double</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Double</span><span class="w"></span>
<span class="nf">strict_mean</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">fromIntegral</span><span class="w"> </span><span class="n">ln</span><span class="w"></span>
<span class="w">  </span><span class="kr">where</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">ln</span><span class="p">)</span><span class="w">        </span><span class="ow">=</span><span class="w"> </span><span class="n">foldl&#39;</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">xs</span><span class="w"></span>
<span class="w">        </span><span class="n">step</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">ln</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">ln</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>

<span class="nf">main</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- generate random test data</span><span class="w"></span>
<span class="w">  </span><span class="n">seed</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">newIOGenM</span><span class="w"> </span><span class="p">(</span><span class="n">mkStdGen</span><span class="w"> </span><span class="mi">1729</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">test_values</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">replicateM</span><span class="w"> </span><span class="mi">500000</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">uniformRM</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">500000</span><span class="p">)</span><span class="w"> </span><span class="n">seed</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- sleep for a second</span><span class="w"></span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">wait</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">threadDelay</span><span class="w"> </span><span class="mi">1000000</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- now run</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">$!</span><span class="w"> </span><span class="n">lazy_mean</span><span class="w"> </span><span class="n">test_values</span><span class="w"></span>
<span class="w">  </span><span class="n">wait</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">$!</span><span class="w"> </span><span class="n">stricter_mean</span><span class="w"> </span><span class="n">test_values</span><span class="w"></span>
<span class="w">  </span><span class="n">wait</span><span class="w"></span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">$!</span><span class="w"> </span><span class="n">strict_mean</span><span class="w"> </span><span class="n">test_values</span><span class="w"></span>
</pre></div>
</div>
<p>We define three functions, each of which calculate a geometric mean from a list
of Doubles. <code class="docutils literal notranslate"><span class="pre">lazy_mean</span></code> uses a lazy left fold, <code class="docutils literal notranslate"><span class="pre">stricter_mean</span></code> uses a strict
left fold but will still have a memory leak because <code class="docutils literal notranslate"><span class="pre">foldl'</span></code> evaluates the
operator to <a class="reference internal" href="../../glossary.html#term-WHNF"><span class="xref std std-term">WHNF</span></a>. The operator in each fold is <code class="docutils literal notranslate"><span class="pre">step</span></code> whose WHNF is a
tuple constructor. Thus, even <code class="docutils literal notranslate"><span class="pre">stricter_mean</span></code> will leak memory because the
elements of the tuple <em>are still</em> lazy. <code class="docutils literal notranslate"><span class="pre">strict_mean</span></code> fixes this by adding
bang patterns <em>inside</em> the tuple, thereby forcing the elements to evaluate to
WHNF; which is just a value for <code class="docutils literal notranslate"><span class="pre">Double</span></code>.</p>
<p>GHC is good at spotting such code patterns so we’ve turned off optimizations
with the <code class="docutils literal notranslate"><span class="pre">OPTIONS_GHC</span> <span class="pre">-O0</span></code> pragma. We use gauge (see <span class="xref std std-ref">Criterion, Gauge,
and Tasty-Bench</span>) to measure the runtime of each function.</p>
</section>
<section id="the-setup">
<h2><span class="section-number">2.2.2.5. </span>The Setup<a class="headerlink" href="#the-setup" title="Permalink to this headline">¶</a></h2>
<p>Using Eventlog requires three pieces of setup. First, you must build your
programs with the <code class="docutils literal notranslate"><span class="pre">-eventlog</span> <span class="pre">-rtsopts</span> <span class="pre">-prof</span></code> GHC flags (or alternatively set
<code class="docutils literal notranslate"><span class="pre">profiling:</span> <span class="pre">True</span></code> in <code class="docutils literal notranslate"><span class="pre">cabal.project</span></code> or enable <code class="docutils literal notranslate"><span class="pre">library-profiling</span></code> and
<code class="docutils literal notranslate"><span class="pre">executable-profiling</span></code> in <code class="docutils literal notranslate"><span class="pre">stack.yaml</span></code>.). For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">benchmark</span> <span class="n">pointerChasing</span>
  <span class="nb">type</span>            <span class="p">:</span> <span class="n">exitcode</span><span class="o">-</span><span class="n">stdio</span><span class="o">-</span><span class="mf">1.0</span>
  <span class="n">default</span><span class="o">-</span><span class="n">language</span><span class="p">:</span> <span class="n">Haskell2010</span>
  <span class="n">ghc</span><span class="o">-</span><span class="n">options</span>     <span class="p">:</span> <span class="o">-</span><span class="n">fforce</span><span class="o">-</span><span class="n">recomp</span> <span class="o">-</span><span class="n">threaded</span> <span class="o">-</span><span class="n">rtsopts</span> <span class="o">-</span><span class="n">prof</span> <span class="o">-</span><span class="n">eventlog</span>
  <span class="n">build</span><span class="o">-</span><span class="n">depends</span><span class="p">:</span> <span class="n">base</span> <span class="o">&gt;=</span> <span class="mf">4.15</span>
               <span class="p">,</span> <span class="n">containers</span>
               <span class="p">,</span> <span class="n">deepseq</span>
               <span class="p">,</span> <span class="n">gauge</span>
               <span class="p">,</span> <span class="n">random</span>
  <span class="n">hs</span><span class="o">-</span><span class="n">source</span><span class="o">-</span><span class="n">dirs</span><span class="p">:</span> <span class="n">bench</span><span class="o">/</span><span class="n">PointerChasing</span>
  <span class="n">main</span><span class="o">-</span><span class="ow">is</span><span class="p">:</span> <span class="n">Main</span><span class="o">.</span><span class="n">hs</span>
</pre></div>
</div>
<p>Second, you must pass the RTS flag <code class="docutils literal notranslate"><span class="pre">-l</span></code> to your program <em>and</em> additional RTS
flags that describe which events to track. Lastly, you must pass RTS flags to
describe the kind of heap information to collect. Here are some examples of RTS
flag combinations:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;program&gt;</span> <span class="pre">+RTS</span> <span class="pre">-hy</span> <span class="pre">-l-agu</span> <span class="pre">-RTS</span></code>: Do not track all possible events
(<code class="docutils literal notranslate"><span class="pre">-a</span></code>), but track all garbage collector events (<code class="docutils literal notranslate"><span class="pre">g</span></code>), all user events
(<code class="docutils literal notranslate"><span class="pre">u</span></code>) and produce a heap profile by type (<code class="docutils literal notranslate"><span class="pre">-hy</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;program&gt;</span> <span class="pre">+RTS</span> <span class="pre">-hr</span> <span class="pre">-la</span> <span class="pre">-RTS</span></code>: Trace all possible events (<code class="docutils literal notranslate"><span class="pre">a</span></code>) and
produce a heap profile by retainer (<code class="docutils literal notranslate"><span class="pre">-hr</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;program&gt;</span> <span class="pre">+RTS</span> <span class="pre">-hb</span> <span class="pre">-l-asu</span> <span class="pre">-RTS</span></code>: Do not track all possible events
(<code class="docutils literal notranslate"><span class="pre">-a</span></code>), but track all scheduler events (<code class="docutils literal notranslate"><span class="pre">s</span></code>), all user events (<code class="docutils literal notranslate"><span class="pre">u</span></code>) and
produce a heap profile by biography (<code class="docutils literal notranslate"><span class="pre">-hb</span></code>).</p></li>
</ol>
</section>
<section id="heap-profile-by-type">
<h2><span class="section-number">2.2.2.6. </span>Heap Profile by Type<a class="headerlink" href="#heap-profile-by-type" title="Permalink to this headline">¶</a></h2>
<p>To view the heap profile we’ll use <a class="reference external" href="https://mpickering.github.io/eventlog2html/">eventlog2html</a>. To begin we’ll inspect the
heap by type. Our initial goal is to determine if we have a memory leak and if
so which type is leaking. Here is the cabal file entry and invocation:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For subsequent runs, we will elide the complete output</p>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Run the benchmark, generate an eventlog of only (-a) user (u) and
GC (g) events with a heap profile by type (-hy)</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cabal bench pointerChasing --benchmark-options<span class="o">=</span><span class="s1">&#39;+RTS -hy -l-agu -RTS&#39;</span>
Build profile: -w ghc-9.2.4 -O1
In order, the following will be built <span class="o">(</span>use -v <span class="k">for</span> more details<span class="o">)</span>:
 - lethargy-0.1.0.0 <span class="o">(</span>bench:pointerChasing<span class="o">)</span> <span class="o">(</span>first run<span class="o">)</span>
Preprocessing benchmark <span class="s1">&#39;pointerChasing&#39;</span> <span class="k">for</span> lethargy-0.1.0.0..
Building benchmark <span class="s1">&#39;pointerChasing&#39;</span> <span class="k">for</span> lethargy-0.1.0.0..
<span class="o">[</span><span class="m">1</span> of <span class="m">1</span><span class="o">]</span> Compiling Main             <span class="o">(</span> bench/PointerChasing/Main.hs, /home/doyougnu/writing/iohk/hs-opt-handbook.github.io/code/lethargy/dist-newstyle/build/x86_64-linux/ghc-9.2.4/lethargy-0.1.0.0/b/pointerChasing/build/pointerChasing/pointerChasing-tmp/Main.o <span class="o">)</span>
<span class="o">[</span><span class="m">1</span> of <span class="m">1</span><span class="o">]</span> Compiling Main             <span class="o">(</span> bench/PointerChasing/Main.hs, /home/doyougnu/writing/iohk/hs-opt-handbook.github.io/code/lethargy/dist-newstyle/build/x86_64-linux/ghc-9.2.4/lethargy-0.1.0.0/b/pointerChasing/build/pointerChasing/pointerChasing-tmp/Main.o <span class="o">)</span>
Linking /home/doyougnu/writing/iohk/hs-opt-handbook.github.io/code/lethargy/dist-newstyle/build/x86_64-linux/ghc-9.2.4/lethargy-0.1.0.0/b/pointerChasing/build/pointerChasing/pointerChasing ...
Running <span class="m">1</span> benchmarks...
Benchmark pointerChasing: RUNNING...
<span class="m">250137</span>.43193906464
<span class="m">250137</span>.43193906464
<span class="m">250137</span>.43193906464
Benchmark pointerChasing: FINISH

$ eventlog2html pointerChasing.eventlog

$ firefox pointerChasing.eventlog.html
</pre></div>
</div>
</div>
<p>which produces the heap profile:</p>
<img alt="../../../_images/pc_heap_type.svg" src="../../../_images/pc_heap_type.svg" /><p>This heap profile is a classic case of a memory leak because it is shaped like a
triangle. It is triangular because <code class="docutils literal notranslate"><span class="pre">lazy_mean</span></code> builds up a lot of thunks;
increasing allocations on the heap and producing the rising edge, the program
reaches a point where the thunks must be evaluated; producing the top of the
triangle, and then begins evaluating them thus decreasing the allocations on the
heap and which yields the descending edge.</p>
<p>The advantage of eventlog2html over <a class="reference internal" href="../../Optimizations/GHC_tech/index.html#ghc-flags"><span class="std std-ref">traditional tools</span></a> is its
interactivity and detailed heap breakdown.</p>
</section>
<section id="tuning-the-output">
<h2><span class="section-number">2.2.2.7. </span>Tuning the Output<a class="headerlink" href="#tuning-the-output" title="Permalink to this headline">¶</a></h2>
</section>
<section id="summary">
<h2><span class="section-number">2.2.2.8. </span>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
</section>
<section id="references-and-further-reading">
<h2><span class="section-number">2.2.2.9. </span>References and Further Reading<a class="headerlink" href="#references-and-further-reading" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>The</p></li>
</ol>
</section>
</section>


          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
  <li class="prev">
    <a href="ghc_flags.html"
       title="previous chapter">← <span class="section-number">2.2.1. </span><span class="lightgrey">GHC Flags</span></a>
  </li>
  <li class="next">
    <a href="ghc_debug.html"
       title="next chapter"><span class="section-number">2.2.3. </span><span class="lightgrey">GHC Debug</span> →</a>
  </li>
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2022-2022, Jeffrey Young (doyougnu).
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>